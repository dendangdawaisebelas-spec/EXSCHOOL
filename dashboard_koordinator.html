<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Koordinator - ICMS</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: 'Times New Roman', serif; margin: 0; background: #f0f2f5; padding-bottom: 50px; }
        header { background: #0a1f44; color: white; padding: 25px; text-align: center; }
        .container { padding: 20px; max-width: 1200px; margin: auto; }
        .btn-main { background: #1c7c54; color: white; border: none; padding: 18px; width: 100%; border-radius: 12px; font-weight: bold; cursor: pointer; margin-bottom: 15px; font-size: 16px; transition: 0.3s; }
        .btn-main:hover { background: #145c3e; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-top: 6px solid #0a1f44; }
        .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .status-ok { background: #e8f5e9; color: #2e7d32; }
        .status-no { background: #ffebee; color: #c62828; }
    </style>
</head>
<body>

<header>
    <h1>Pusat Komando Koordinator ICMS</h1>
    <p>Pembina: Ditya Manggala, S.Sn</p>
</header>

<div class="container">
    <button class="btn-main" onclick="cetakRAB()">ðŸ“¥ DOWNLOAD RAB HONOR PELATIH (PDF)</button>
    <button class="btn-main" style="background:#0a1f44" onclick="cetakLaporanBulanan()">ðŸ“˜ DOWNLOAD LAPORAN BULANAN FORMAL (PDF)</button>
    
    <h2 style="color:#0a1f44; border-bottom: 2px solid #0a1f44; padding-bottom: 10px;">Monitoring Evaluasi Ekskul</h2>
    
    <div class="grid" id="gridEkskul">
        </div>
</div>

<script>
    const { jsPDF } = window.jspdf;

    // Database Tarif per Pertemuan (Sesuai RAB Bapak)
    const tData = { 
        "Panahan": 300000, 
        "Futsal": 250000, 
        "Dokter Kecil": 100000, 
        "Badminton": 150000, 
        "Basket": 250000, 
        "Renang": 150000, 
        "Pramuka": 160000, 
        "Musik": 500000, // Tarif Flat per Bulan
        "Taekwondo": 0,  // Diinput manual via invoice
        "Nihonggo Club": 0,
        "English Club": 0
    };

    const ekskuls = Object.keys(tData);

    function renderDashboard() {
        const grid = document.getElementById("gridEkskul");
        grid.innerHTML = "";

        ekskuls.forEach(nama => {
            const dataHarian = JSON.parse(localStorage.getItem("data_" + nama)) || [];
            const evaluasi = JSON.parse(localStorage.getItem("eval_" + nama)) || null;
            
            // Hitung Honor
            let totalHonor = 0;
            if (nama === "Musik") {
                totalHonor = 500000;
            } else if (nama === "Taekwondo") {
                totalHonor = parseInt(localStorage.getItem("t_Taek")) || 0;
            } else {
                totalHonor = dataHarian.length * tData[nama];
            }

            grid.innerHTML += `
                <div class="card">
                    <h3 style="margin: 0 0 10px 0;">${nama}</h3>
                    <p>Jumlah Pertemuan: <b>${dataHarian.length} kali</b></p>
                    <p>Estimasi Honor: <b>Rp ${totalHonor.toLocaleString()}</b></p>
                    <hr>
                    <p>Status Evaluasi Bulanan: 
                        ${evaluasi 
                            ? '<span class="status-badge status-ok">LENGKAP + 3 FOTO</span>' 
                            : '<span class="status-badge status-no">BELUM DIISI</span>'}
                    </p>
                </div>
            `;
        });
    }

    // FUNGSI 1: CETAK RAB
    function cetakRAB() {
        const doc = new jsPDF();
        doc.setFontSize(14);
        doc.text("RENCANA ANGGARAN BIAYA (RAB) HONOR PELATIH", 105, 15, {align:"center"});
        doc.text("ICMS - NOVEMBER 2025", 105, 22, {align:"center"});

        let rows = [];
        let grandTotal = 0;

        ekskuls.forEach((nama, i) => {
            let dataHarian = JSON.parse(localStorage.getItem("data_" + nama)) || [];
            let sub = (nama === "Musik") ? 500000 : (nama === "Taekwondo" ? parseInt(localStorage.getItem("t_Taek")) || 0 : dataHarian.length * tData[nama]);
            grandTotal += sub;
            rows.push([i+1, nama, "Rp " + tData[nama].toLocaleString(), dataHarian.length, "Rp " + sub.toLocaleString()]);
        });

        doc.autoTable({
            startY: 30,
            head: [['No', 'Ekstrakurikuler', 'Tarif Satuan', 'Vol', 'Total']],
            body: rows,
            foot: [['', '', '', 'GRAND TOTAL', "Rp " + grandTotal.toLocaleString()]]
        });

        doc.text("Bogor, 25 November 2025", 140, doc.lastAutoTable.finalY + 20);
        doc.text("Koordinator Ekskul,", 140, doc.lastAutoTable.finalY + 27);
        doc.text("( Ditya Manggala, S.Sn )", 140, doc.lastAutoTable.finalY + 50);

        doc.save("RAB_Honor_ICMS.pdf");
    }

    // FUNGSI 2: CETAK LAPORAN BULANAN FORMAL + FOTO
    function cetakLaporanBulanan() {
        const doc = new jsPDF();
        const periode = prompt("Masukkan Periode Laporan:", "NOVEMBER 2025");

        // --- HALAMAN COVER ---
        doc.setFont("times", "bold"); doc.setFontSize(18);
        doc.text("LAPORAN BULANAN EKSTRAKURIKULER", 105, 80, {align:"center"});
        doc.text("SMP - SMA INSAN CENDEKIA MAGNET SCHOOL", 105, 90, {align:"center"});
        doc.setFontSize(14); doc.text(periode, 105, 100, {align:"center"});
        
        doc.setFontSize(12);
        doc.text("Disusun Oleh:", 105, 150, {align:"center"});
        doc.text("Ditya Manggala, S.Sn", 105, 157, {align:"center"});

        // --- LOOPING DATA TIAP EKSKUL ---
        ekskuls.forEach(nama => {
            const ev = JSON.parse(localStorage.getItem("eval_" + nama));
            
            if(ev) {
                // Halaman Narasi
                doc.addPage();
                doc.setFont("times", "bold"); doc.setFontSize(14);
                doc.text("EVALUASI BULANAN: " + nama.toUpperCase(), 20, 20);
                
                doc.setFont("times", "normal"); doc.setFontSize(11);
                let y = 35;
                doc.text("1. Agenda Kegiatan:", 20, y);
                doc.text(doc.splitTextToSize(ev.agenda || "-", 170), 25, y + 7);
                
                y += 25;
                doc.text("2. Hasil & Capaian Siswa:", 20, y);
                doc.text(doc.splitTextToSize(ev.capaian || "-", 170), 25, y + 7);
                
                y += 25;
                doc.text("3. Kendala & Hambatan:", 20, y);
                doc.text(doc.splitTextToSize(ev.kendala || "-", 170), 25, y + 7);

                // Halaman Lampiran Foto (Jika Ada)
                if(ev.fotos && ev.fotos.length >= 3) {
                    doc.addPage();
                    doc.setFont("times", "bold");
                    doc.text("LAMPIRAN FOTO KEGIATAN: " + nama.toUpperCase(), 105, 20, {align:"center"});
                    
                    // Tata letak 3 foto
                    try {
                        doc.addImage(ev.fotos[0], 'JPEG', 30, 30, 150, 75);
                        doc.addImage(ev.fotos[1], 'JPEG', 30, 115, 150, 75);
                        doc.addPage();
                        doc.addImage(ev.fotos[2], 'JPEG', 30, 30, 150, 75);
                    } catch (e) {
                        doc.text("[Gagal memuat foto - Pastikan format gambar benar]", 50, 50);
                    }
                }
            }
        });

        doc.save(`Laporan_Formal_ICMS_${periode}.pdf`);
    }

    // Jalankan render saat halaman dibuka
    renderDashboard();
</script>

</body>
</html>
